<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chamindu Yasintha - Agentic RAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "brand-primary": "#6366f1",
              "brand-dark": "#1e1b4b",
              "agent-thinking": "#374151",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #0f172a;
      }
      #chat-history::-webkit-scrollbar {
        width: 6px;
      }
      #chat-history::-webkit-scrollbar-thumb {
        background: #4f46e5;
        border-radius: 10px;
      }

      /* Thinking Process Animation */
      .thinking-pulse {
        animation: pulse-text 2s infinite;
      }
      @keyframes pulse-text {
        0% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.5;
        }
      }

      /* Source Citation Styling */
      .citation-badge {
        display: inline-flex;
        align-items: center;
        background-color: #312e81;
        color: #c7d2fe;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
        margin-top: 8px;
        margin-right: 4px;
        border: 1px solid #4f46e5;
      }

      /* Message Animation */
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .message-enter {
        animation: slideInRight 0.3s ease-out;
      }

      .message-enter-user {
        animation: slideInLeft 0.3s ease-out;
      }

      /* Robot Avatar Animation */
      @keyframes pulse-avatar {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 8px rgba(99, 102, 241, 0);
        }
      }

      .avatar-pulse {
        animation: pulse-avatar 2s infinite;
      }

      .avatar-typing {
        animation: pulse-avatar 0.8s infinite;
      }

      /* Typing Indicator */
      @keyframes typing-dots {
        0%,
        20% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      .typing-dot {
        animation: typing-dots 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      /* Typing Cursor */
      @keyframes blink-cursor {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      .typing-cursor {
        animation: blink-cursor 1s infinite;
        color: currentColor;
      }

      /* Status Indicator */
      @keyframes status-pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .status-online {
        animation: status-pulse 2s infinite;
      }

      .status-typing {
        animation: status-pulse 0.8s infinite;
      }
    </style>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet" />
  </head>
  <body
    class="text-gray-200 antialiased h-screen flex flex-col items-center justify-center p-4">
    <div
      class="w-full max-w-3xl bg-gray-900 border border-gray-700 shadow-2xl rounded-xl flex flex-col h-[90vh]">
      <div
        class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-xl">
        <div class="flex items-center space-x-3">
          <div
            id="bot-avatar"
            class="w-10 h-10 bg-brand-primary rounded-full flex items-center justify-center avatar-pulse">
            <i class="fa-solid fa-robot text-white"></i>
          </div>
          <div>
            <h1 class="font-bold text-white text-lg">Chamindu's Agent</h1>
            <p
              id="bot-status"
              class="text-xs text-green-400 font-mono status-online">
              <i class="fa-solid fa-circle text-[8px] mr-1"></i
              ><span id="status-text">Online</span>
            </p>
          </div>
        </div>
        <div>
          <input
            type="file"
            id="knowledge-upload"
            accept=".pdf,.txt"
            class="hidden" />
          <label
            for="knowledge-upload"
            class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-xs text-white py-2 px-3 rounded border border-gray-600 transition flex items-center gap-2">
            <i class="fa-solid fa-upload"></i> Load Knowledge
          </label>
        </div>
      </div>

      <div id="chat-history" class="flex-1 p-6 overflow-y-auto space-y-6"></div>

      <div class="p-4 bg-gray-800 rounded-b-xl border-t border-gray-700">
        <div class="relative">
          <input
            type="text"
            id="chat-input"
            placeholder="Hi! What would you like to know? ðŸ˜Š"
            class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg pl-4 pr-12 py-4 focus:outline-none focus:border-brand-primary focus:ring-1 focus:ring-brand-primary transition shadow-inner" />
          <button
            id="send-button"
            class="absolute right-2 top-2 bottom-2 bg-brand-primary hover:bg-indigo-500 text-white rounded-md px-4 transition">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <script>
      const chatHistory = document.getElementById("chat-history");
      const chatInput = document.getElementById("chat-input");
      const sendBtn = document.getElementById("send-button");
      const uploadInput = document.getElementById("knowledge-upload");
      const botAvatar = document.getElementById("bot-avatar");
      const botStatus = document.getElementById("bot-status");
      const statusText = document.getElementById("status-text");
      // Auto-detect backend URL for local dev vs GCP VM deployment
      const backendUrl =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
          ? "http://127.0.0.1:5000"
          : window.location.port === "8000" ||
            window.location.pathname.includes("index.html")
          ? `http://${window.location.hostname}:5000` // Simple setup: direct Flask on port 5000
          : "/api"; // Production setup: Nginx proxy

      let conversationHistory = [];
      let isTyping = false;

      // Update bot status
      function updateStatus(text, color = "text-green-400") {
        statusText.textContent = text;
        botStatus.className = `text-xs ${color} font-mono status-online`;
        if (text === "Typing...") {
          botStatus.className = `text-xs ${color} font-mono status-typing`;
          botAvatar.className =
            "w-10 h-10 bg-brand-primary rounded-full flex items-center justify-center avatar-typing";
        } else {
          botAvatar.className =
            "w-10 h-10 bg-brand-primary rounded-full flex items-center justify-center avatar-pulse";
        }
      }

      // Welcome message on page load with typing effect
      window.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          typeMessage(
            "bot",
            "ðŸ‘‹ Hi there! I'm your AI assistant. Upload a document using the 'Load Knowledge' button above, and I'll help answer any questions you have about it! How can I assist you today? ðŸ˜Š"
          );
        }, 500);
      });

      // 1. Render Message with "Thought Process" and animation
      function appendMessage(
        role,
        text,
        thoughts = null,
        sources = [],
        animate = true
      ) {
        const div = document.createElement("div");
        div.className = `flex flex-col ${
          role === "user" ? "items-end" : "items-start"
        } ${
          animate
            ? role === "user"
              ? "message-enter-user"
              : "message-enter"
            : ""
        }`;

        let innerHTML = "";

        // If Bot, show Thinking Process Dropdown
        if (role === "bot" && thoughts) {
          innerHTML += `
                <div class="mb-2 max-w-xl w-full">
                    <details class="group">
                        <summary class="list-none cursor-pointer text-xs text-gray-400 hover:text-brand-primary transition flex items-center gap-2 bg-gray-800 p-2 rounded border border-gray-700">
                            <i class="fa-solid fa-brain text-brand-primary"></i> Agent Thought Process
                            <i class="fa-solid fa-chevron-down ml-auto group-open:rotate-180 transition"></i>
                        </summary>
                        <div class="mt-2 p-3 bg-black/30 rounded text-xs font-mono text-gray-400 border-l-2 border-brand-primary">
                            ${thoughts.map((t) => `<div>> ${t}</div>`).join("")}
                        </div>
                    </details>
                </div>`;
        }

        // Message Bubble
        innerHTML += `
                <div class="max-w-xl px-5 py-3 rounded-2xl ${
                  role === "user"
                    ? "bg-brand-primary text-white rounded-br-none"
                    : "bg-gray-700 text-gray-200 rounded-bl-none border border-gray-600 shadow-lg"
                }">
                    <div class="prose prose-invert text-sm leading-relaxed">${formatMarkdown(
                      text
                    )}</div>
                    ${renderSources(sources)}
                </div>
            `;

        div.innerHTML = innerHTML;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      // Type message character by character for more alive feel
      function typeMessage(
        role,
        text,
        thoughts = null,
        sources = [],
        speed = 20
      ) {
        if (isTyping) return;
        isTyping = true;
        updateStatus("Typing...", "text-yellow-400");

        const timestamp = Date.now();
        const div = document.createElement("div");
        div.className = `flex flex-col ${
          role === "user" ? "items-end" : "items-start"
        } message-enter`;

        let innerHTML = "";

        // If Bot, show Thinking Process Dropdown
        if (role === "bot" && thoughts) {
          innerHTML += `
                <div class="mb-2 max-w-xl w-full">
                    <details class="group">
                        <summary class="list-none cursor-pointer text-xs text-gray-400 hover:text-brand-primary transition flex items-center gap-2 bg-gray-800 p-2 rounded border border-gray-700">
                            <i class="fa-solid fa-brain text-brand-primary"></i> Agent Thought Process
                            <i class="fa-solid fa-chevron-down ml-auto group-open:rotate-180 transition"></i>
                        </summary>
                        <div class="mt-2 p-3 bg-black/30 rounded text-xs font-mono text-gray-400 border-l-2 border-brand-primary">
                            ${thoughts.map((t) => `<div>> ${t}</div>`).join("")}
                        </div>
                    </details>
                </div>`;
        }

        // Message Bubble with typing indicator
        innerHTML += `
                <div class="max-w-xl px-5 py-3 rounded-2xl ${
                  role === "user"
                    ? "bg-brand-primary text-white rounded-br-none"
                    : "bg-gray-700 text-gray-200 rounded-bl-none border border-gray-600 shadow-lg"
                }">
                    <div class="prose prose-invert text-sm leading-relaxed" id="typing-content-${timestamp}"></div>
                    <div id="typing-sources-${timestamp}"></div>
                </div>
            `;

        div.innerHTML = innerHTML;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        const contentDiv = div.querySelector(`#typing-content-${timestamp}`);
        const sourcesDiv = div.querySelector(`#typing-sources-${timestamp}`);

        let index = 0;
        const typingInterval = setInterval(() => {
          if (index < text.length) {
            contentDiv.innerHTML =
              formatMarkdown(text.substring(0, index + 1)) +
              '<span class="typing-cursor">|</span>';
            index++;
            chatHistory.scrollTop = chatHistory.scrollHeight;
          } else {
            clearInterval(typingInterval);
            contentDiv.innerHTML = formatMarkdown(text);
            if (sources && sources.length > 0) {
              sourcesDiv.innerHTML = renderSources(sources);
            }
            isTyping = false;
            updateStatus("Online", "text-green-400");
          }
        }, speed);
      }

      function renderSources(sources) {
        if (!sources || sources.length === 0) return "";
        return `
                <div class="mt-3 pt-3 border-t border-gray-600 flex flex-wrap">
                    ${sources
                      .map(
                        (s) =>
                          `<span class="citation-badge"><i class="fa-regular fa-file-lines mr-1"></i> ${s}</span>`
                      )
                      .join("")}
                </div>
            `;
      }

      function formatMarkdown(text) {
        return text
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\n/g, "<br>");
      }

      async function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg) return;

        appendMessage("user", msg);
        chatInput.value = "";
        conversationHistory.push({ role: "user", parts: [{ text: msg }] });
        updateStatus("Reading...", "text-blue-400");

        // Add a temporary "Thinking" bubble with animated dots
        setTimeout(() => {
          updateStatus("Thinking...", "text-yellow-400");
        }, 200);
        const loadingId = "loading-" + Date.now();
        const loadingDiv = document.createElement("div");
        loadingDiv.id = loadingId;
        loadingDiv.className =
          "flex items-center gap-2 text-gray-400 text-sm mt-4 ml-2 message-enter";
        loadingDiv.innerHTML = `
          <div class="flex items-center gap-1">
            <span class="typing-dot w-2 h-2 bg-brand-primary rounded-full"></span>
            <span class="typing-dot w-2 h-2 bg-brand-primary rounded-full"></span>
            <span class="typing-dot w-2 h-2 bg-brand-primary rounded-full"></span>
          </div>
          <span>Let me think about that for you...</span>
        `;
        chatHistory.appendChild(loadingDiv);

        try {
          const res = await fetch(`${backendUrl}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: msg,
              history: conversationHistory,
            }),
          });
          const data = await res.json();

          document.getElementById(loadingId).remove();
          updateStatus("Typing...", "text-blue-400");

          conversationHistory.push({
            role: "model",
            parts: [{ text: data.reply }],
          });

          // Use typing effect for bot responses
          setTimeout(() => {
            typeMessage("bot", data.reply, data.thoughts, data.sources, 15);
          }, 300);
        } catch (err) {
          document.getElementById(loadingId).remove();
          updateStatus("Error", "text-red-400");
          setTimeout(() => {
            typeMessage(
              "bot",
              "Oops! I'm having trouble connecting right now. Could you please check if the server is running? ðŸ˜…"
            );
            setTimeout(() => updateStatus("Online", "text-green-400"), 2000);
          }, 300);
        }
      }

      // File Upload Logic
      uploadInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        updateStatus("Processing...", "text-purple-400");
        // Use appendMessage for instant display of status message
        appendMessage(
          "bot",
          `Great! I'm reading *${file.name}* for you. This will just take a moment... ðŸ“š`,
          null,
          [],
          true
        );

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch(`${backendUrl}/upload`, {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          updateStatus("Learning...", "text-purple-400");

          // Wait a bit for the upload to process, then show success message
          // Calculate wait time based on whether typing is in progress
          const waitForTyping = () => {
            return new Promise((resolve) => {
              if (!isTyping) {
                resolve();
                return;
              }
              const checkInterval = setInterval(() => {
                if (!isTyping) {
                  clearInterval(checkInterval);
                  resolve();
                }
              }, 100);
            });
          };

          await waitForTyping();
          setTimeout(() => {
            typeMessage("bot", data.message);
            // Calculate when typing will finish (text length * speed + buffer)
            const typingDuration = data.message.length * 15 + 500;
            setTimeout(
              () => updateStatus("Online", "text-green-400"),
              typingDuration
            );
          }, 300);
        } catch (err) {
          updateStatus("Error", "text-red-400");
          // Wait for any ongoing typing to finish
          const waitForTyping = () => {
            return new Promise((resolve) => {
              if (!isTyping) {
                resolve();
                return;
              }
              const checkInterval = setInterval(() => {
                if (!isTyping) {
                  clearInterval(checkInterval);
                  resolve();
                }
              }, 100);
            });
          };

          await waitForTyping();
          setTimeout(() => {
            typeMessage(
              "bot",
              "Oops! Something went wrong while uploading the file. Please try again. ðŸ˜…"
            );
            setTimeout(() => updateStatus("Online", "text-green-400"), 2000);
          }, 300);
        }
      });

      sendBtn.addEventListener("click", sendMessage);
      chatInput.addEventListener(
        "keypress",
        (e) => e.key === "Enter" && sendMessage()
      );
    </script>
  </body>
</html>
